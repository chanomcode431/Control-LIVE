<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Game Overlay Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Kanit:wght@800&display=swap');
        body { background-color: rgba(0, 0, 0, 0); margin: 0; padding: 0; overflow: hidden; font-family: 'Kanit', sans-serif; text-align: center; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; text-shadow: 3px 3px 0px #000; }
        #timer { font-size: 150px; font-weight: 900; font-family: 'Black Ops One', sans-serif; opacity: 1; transition: opacity 0.5s ease-out; }
        .intro-text { color: #ffd700 !important; font-size: 80px !important; }
        .panic-mode { color: #ff0000 !important; animation: panic-pulse 0.5s infinite; text-shadow: 0 0 20px red; }
        .time-up-static { color: #ff0000 !important; transform: scale(1.2); }
        .text-message { color: #00ffa2 !important; font-size: 80px !important; }
        @keyframes panic-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        .hidden { opacity: 0 !important; visibility: hidden; }
    </style>
</head>
<body>
    <div id="timer">WAITING</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDgn9Vll-qcLhw7dcNtA9oGKy_BCRuefIs",
            authDomain: "control-tiktok.firebaseapp.com",
            databaseURL: "https://control-tiktok-default-rtdb.firebaseio.com",
            projectId: "control-tiktok",
            storageBucket: "control-tiktok.firebasestorage.app",
            messagingSenderId: "771700169818",
            appId: "1:771700169818:web:abe98c40c5b1baabab0c63"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const database = firebase.database();
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('id');
        const timerEl = document.getElementById('timer');
        let timerInterval = null;
        let fadeTimeout = null;

        if (roomId) {
            database.ref(roomId).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                if (fadeTimeout) clearTimeout(fadeTimeout);
                timerEl.classList.remove("hidden");

                if (data.mode === 'stop') {
                    if (timerInterval) clearInterval(timerInterval);
                    timerEl.innerText = "RESET";
                    fadeTimeout = setTimeout(() => { timerEl.classList.add("hidden"); }, 2000);
                } else if (data.mode === 'text') {
                    if (timerInterval) clearInterval(timerInterval);
                    timerEl.innerText = data.message;
                    timerEl.className = "text-message";
                    fadeTimeout = setTimeout(() => { timerEl.classList.add("hidden"); }, 5000);
                } else if (data.mode === 'running') {
                    startSyncTimer(data);
                }
            });
        }

        function startSyncTimer(data) {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = data.target - now;
                const secLeft = Math.ceil(diff / 1000);
                if (now - data.timestamp < 2500) {
                    timerEl.innerText = data.introText || "READY?";
                    timerEl.className = "intro-text";
                } else if (diff <= 0) {
                    timerEl.innerText = data.outroText || "0";
                    timerEl.className = "time-up-static";
                    clearInterval(timerInterval);
                    fadeTimeout = setTimeout(() => { timerEl.classList.add("hidden"); }, 2000);
                } else {
                    timerEl.innerText = secLeft;
                    timerEl.className = secLeft <= 3 ? "panic-mode" : "";
                }
            }, 100);
        }
    </script>
</body>
</html>
