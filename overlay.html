<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Game Overlay</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* พื้นหลังโปร่งใส สำหรับ OBS */
        body { 
            background-color: rgba(0, 0, 0, 0); 
            margin: 0; padding: 0; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, sans-serif;
            text-align: center;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh;
            color: white;
            text-shadow: 2px 2px 4px #000;
        }

        .container {
            /* ปรับแต่งกรอบตามใจชอบ */
            padding: 20px;
        }

        #gameName {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00e676; /* สีเขียว */
        }

        #timer {
            font-size: 120px;
            font-weight: bold;
            font-family: monospace;
            line-height: 1;
        }

        /* สถานะตอนหยุด */
        .stopped { color: #ff4444; }
        .running { color: #ffffff; }
    </style>
</head>
<body>

    <div class="container">
        <div id="gameName">รอสัญญาณ...</div>
        <div id="timer">00:00</div>
    </div>

    <script>
        // --- 1. การตั้งค่า Firebase (ชุดเดียวกับตัว Control) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDgn9Vll-qcLhw7dcNtA9oGKy_BCRuefIs",
            authDomain: "control-tiktok.firebaseapp.com",
            databaseURL: "https://control-tiktok-default-rtdb.firebaseio.com",
            projectId: "control-tiktok",
            storageBucket: "control-tiktok.firebasestorage.app",
            messagingSenderId: "771700169818",
            appId: "1:771700169818:web:abe98c40c5b1baabab0c63",
            measurementId: "G-DZ76HRE0RM"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }

        // --- 2. ส่วนสำคัญ: รับ Room ID จากลิ้งค์ ---
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('id'); // ดึงค่าจาก ?id=...

        const gameNameEl = document.getElementById('gameName');
        const timerEl = document.getElementById('timer');
        let timerInterval = null;

        if (!roomId) {
            gameNameEl.innerText = "Error: ไม่พบ Room ID";
            gameNameEl.style.color = "red";
            timerEl.innerText = "Link ผิด";
        } else {
            // เชื่อมต่อ Firebase ไปที่ห้องนั้นๆ
            const dbRef = firebase.database().ref(roomId);

            dbRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    // อัปเดตชื่อเกม
                    if(data.game) gameNameEl.innerText = data.game;

                    // อัปเดตสถานะ
                    if (data.mode === 'stop') {
                        stopTimer();
                        timerEl.innerText = "00:00";
                        timerEl.className = "stopped";
                    } else if (data.mode === 'running') {
                        // คำนวณเวลาที่เหลือโดยอิงจาก Target Time (Server Time)
                        // เพื่อให้เวลาตรงกันแม้เน็ตจะดีเลย์
                        startSyncTimer(data.target);
                        timerEl.className = "running";
                    }
                }
            });
        }

        function startSyncTimer(targetTime) {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const diff = targetTime - now;

                if (diff <= 0) {
                    timerEl.innerText = "00:00";
                    stopTimer();
                    // อาจจะเพิ่มเสียงแจ้งเตือนหมดเวลาตรงนี้
                } else {
                    // แปลง millisecond เป็น วินาที
                    const secondsLeft = Math.ceil(diff / 1000);
                    timerEl.innerText = formatTime(secondsLeft);
                }
            }, 100); // อัปเดตทุก 0.1 วิ เพื่อความลื่นไหล
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

    </script>
</body>
</html>
