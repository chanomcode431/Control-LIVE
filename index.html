<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Control Deck (Pro Version)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Chakra+Petch:wght@600&family=Kanit:wght@300;600&family=Orbitron:wght@700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --bg-sidebar: #181818;
            --primary: #00e676;
            --danger: #ff5252;
            --text-main: #ffffff;
            --text-muted: #b0bec5;
            --accent-blue: #2979ff;
            --accent-orange: #ff9100;
            --admin-purple: #d500f9;
        }

        * { box-sizing: border-box; }
        
        /* Global Font Defaults */
        body, input, button, select, textarea { 
            font-family: 'Kanit', sans-serif; 
        }

        /* Digital Font Style (For Timer) */
        .digital-font {
            font-family: 'Black Ops One', cursive; /* Default */
            font-size: 70px;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        body { 
            margin: 0; padding: 0; 
            background: var(--bg-dark); 
            color: var(--text-main);
            height: 100vh; 
            display: flex; 
            overflow: hidden;
        }

        /* --- UI COMPONENTS --- */
        .hide-box { display: none !important; }
        .hidden { opacity: 0 !important; }

        /* Login */
        #login-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .login-box {
            background: var(--bg-card); padding: 40px; border-radius: 20px;
            width: 100%; max-width: 350px; text-align: center; 
            border: 1px solid #333; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* User Info */
        .user-info-top {
            position: fixed; top: 15px; right: 20px; font-size: 12px;
            background: rgba(30,30,30,0.9); padding: 8px 15px; border-radius: 20px;
            display: flex; align-items: center; gap: 10px; z-index: 1500; 
            border: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Sidebar */
        .sidebar { 
            width: 260px; background: var(--bg-sidebar); border-right: 1px solid #333; 
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3); z-index: 10;
        }
        .brand { font-size: 20px; font-weight: 600; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .menu-label { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        
        .game-btn {
            padding: 12px 15px; border-radius: 8px; background: transparent; color: var(--text-muted);
            cursor: pointer; font-size: 16px; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 12px; border: 1px solid transparent;
        }
        .game-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .game-btn.active { background: rgba(0, 230, 118, 0.15); color: var(--primary); border: 1px solid rgba(0, 230, 118, 0.3); font-weight: 600; }
        
        .admin-section { margin-top: auto; border-top: 1px solid #333; padding-top: 20px; }
        .admin-btn { border: 1px dashed var(--accent-blue) !important; color: var(--accent-blue) !important; }
        .admin-btn.active { background: rgba(41, 121, 255, 0.15); color: white !important; }
        .my-room-btn { border: 1px solid var(--primary) !important; color: var(--primary) !important; margin-bottom: 10px; }
        .my-room-btn:hover { background: rgba(0, 230, 118, 0.1) !important; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 30px; overflow-y: auto; align-items: center; }
        .dashboard-card { background: var(--bg-card); border-radius: 20px; padding: 40px; width: 100%; max-width: 600px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }

        /* Admin Grid */
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; width: 100%; }
        .room-card { 
            background: #151515; border: 1px solid #333; border-radius: 12px; padding: 15px; 
            text-align: left; transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .room-card:hover { border-color: var(--accent-blue); transform: translateY(-3px); }
        .btn-mini { padding: 6px 12px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer; margin-right: 5px; font-weight: 600; letter-spacing: 0.5px; }

        /* Controls */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        #timer-container { background: #000; border: 4px solid #333; border-radius: 12px; height: 180px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); }
        
        #preview-display { 
            color: white; text-align: center; 
        }

        .control-group { margin-bottom: 20px; text-align: center; }
        .custom-input { background: #2a2a2a; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; outline: none; font-size: 14px; transition: 0.3s; width:100%; }
        .custom-input:focus { border-color: var(--primary); }
        
        input[type="number"] { background: #2a2a2a; border: 2px solid #444; color: white; font-size: 36px; width: 100%; max-width: 200px; text-align: center; padding: 10px; border-radius: 12px; outline: none; }

        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        button { flex: 1; padding: 18px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; color: white; text-transform: uppercase; }
        .btn-start { background: linear-gradient(135deg, #00e676, #00b359); box-shadow: 0 4px 15px rgba(0,230,118,0.3); }
        .btn-reset { background: #333; color: #ff5252; border: 1px solid #ff5252; }
        .btn-send { background: linear-gradient(135deg, #2979ff, #1565c0); }

        /* AHK Box */
        .ahk-box { background: rgba(255, 145, 0, 0.1); border: 1px solid var(--accent-orange); border-radius: 12px; padding: 15px; margin-top: 15px; text-align: left; }

        /* --- SETTINGS POPUP (New) --- */
        .settings-btn { 
            position: absolute; top: 20px; right: 20px; 
            background: #333; color: #aaa; width: 35px; height: 35px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
        }
        .settings-btn:hover { background: #444; color: white; transform: rotate(90deg); }
        
        .settings-popup {
            position: absolute; top: 60px; right: 20px; width: 280px;
            background: #252525; border: 1px solid #444; border-radius: 12px;
            padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100;
            display: flex; flex-direction: column; gap: 12px;
            animation: fadeIn 0.2s;
        }
        .setting-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #ccc; }
        .sm-select { background: #151515; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 6px; font-size: 12px; width: 120px; }
        .sm-input { background: #151515; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 6px; width: 50px; text-align: center; font-size: 12px; }
        
        /* Toggle Switch */
        .toggle-switch { width: 40px; height: 20px; background: #444; border-radius: 10px; position: relative; cursor: pointer; transition: 0.3s; }
        .toggle-switch.on { background: var(--primary); }
        .toggle-switch::after { content:''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.on::after { left: 22px; }

        /* Reset Link Btn */
        .reset-zone-btn { margin-top: 20px; border: 2px dashed #444; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; color: #666; font-size: 12px; transition: all 0.3s; }
        .reset-zone-btn:hover { border-color: var(--danger); color: var(--danger); background: rgba(255, 82, 82, 0.05); }

        /* Admin Modal */
        .hijack-modal { background: #1a1a1a; width: 90%; max-width: 500px; border-radius: 15px; border: 2px solid var(--accent-blue); padding: 0; overflow: hidden; }
        .hijack-header { background: var(--accent-blue); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .hijack-body { padding: 20px; text-align: center; }
        .h-mode-btn { background: #2a2a2a; border: 1px solid #444; color: #888; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin: 0 4px; }
        .h-mode-btn.active { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(41, 121, 255, 0.1); }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .preview-intro { color: #ffd700 !important; font-size: 36px !important; }
        .preview-panic { color: #ff0000 !important; animation: panic 0.5s infinite; }
        @keyframes panic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .status-badge-my { background: rgba(0, 230, 118, 0.2); color: var(--primary); padding: 5px 10px; border-radius: 10px; font-size: 12px; border: 1px solid var(--primary); }
        .status-badge-hijack { background: rgba(213, 0, 249, 0.2); color: var(--admin-purple); padding: 5px 10px; border-radius: 10px; font-size: 12px; border: 1px solid var(--admin-purple); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-top:0;"><i class="fas fa-shield-alt"></i> SYSTEM LOGIN</h2>
            <input type="email" id="email" class="custom-input" placeholder="Email" style="text-align: center; margin-bottom: 10px;">
            <input type="password" id="password" class="custom-input" placeholder="Password" style="text-align: center; margin-bottom: 20px;" onkeyup="if(event.key === 'Enter') handleLogin()">
            <button onclick="handleLogin()" class="btn-start" style="width:100%;">LOGIN</button>
            <p id="login-error" style="color: var(--danger); font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand"><i class="fas fa-gamepad"></i> STiMEXs <span style="font-size:10px; opacity:0.5;">v6.5</span></div>
        <div style="font-size:12px; color:#555; margin-bottom:10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°</div>
        <div class="game-btn active" onclick="selectGame('Roblox', 60, this)"><i class="fas fa-cube"></i> Roblox</div>
        <div class="game-btn" onclick="selectGame('OnlyUp', 10, this)"><i class="fas fa-arrow-up"></i> OnlyUp</div>
        <div class="game-btn" onclick="selectGame('Horror', 60, this)"><i class="fas fa-ghost"></i> Horror</div>
        <div class="game-btn" onclick="selectGame('Talk', 0, this)"><i class="fas fa-comment-dots"></i> Talk / Chat</div>
        
        <div id="admin-menu" class="admin-section hide-box">
            <div style="font-size:12px; color:#555; margin-bottom:10px;">ADMIN SYSTEM</div>
            <div class="game-btn my-room-btn" onclick="switchToMyRoom()"><i class="fas fa-user-astronaut"></i> My Control</div>
            <div class="game-btn admin-btn" onclick="showAdminPanel()"><i class="fas fa-users-cog"></i> Active Rooms</div>
        </div>
        
        <div style="margin-top:auto; font-size:11px; color:#444; text-align:center;">
            <span id="display-email">Guest</span> <i class="fas fa-sign-out-alt" style="cursor:pointer; margin-left:5px;" onclick="handleLogout()"></i>
        </div>
    </div>

    <div class="main-content">
        
        <div id="admin-panel-view" class="dashboard-card hide-box" style="width:100%; max-width:800px;">
            <div class="header-row">
                <h2 style="color:var(--accent-blue); margin:0;">Active Rooms</h2>
                <button class="btn-reset" style="padding:5px 10px; width:auto; font-size:12px;" onclick="loadRooms()">REFRESH</button>
            </div>
            <div class="room-grid" id="room-list"></div>
        </div>

        <div id="control-panel-view" class="dashboard-card">
            <div class="settings-btn" onclick="toggleSettings()"><i class="fas fa-cog"></i></div>
            
            <div id="settings-menu" class="settings-popup hide-box">
                <div class="setting-row">
                    <span><i class="fas fa-volume-up"></i> Sound Effect</span>
                    <div id="sound-toggle" class="toggle-switch" onclick="toggleSound()"></div>
                </div>
                <div class="setting-row">
                    <span>Sound Type</span>
                    <select id="sound-type" class="sm-select" onchange="if(isSoundOn) playSoundEffect()">
                        <option value="classic">Classic Beep</option>
                        <option value="high">High Pitch</option>
                        <option value="8bit">8-Bit Retro</option>
                        <option value="low">Low Alert</option>
                        <option value="soft">Soft Bell</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span>Warn at (sec)</span>
                    <input type="number" id="sound-sec-start" value="10" class="sm-input">
                </div>
                <div style="border-top:1px solid #333; margin:5px 0;"></div>
                <div class="setting-row">
                    <span><i class="fas fa-font"></i> Font Style</span>
                    <select id="font-select" class="sm-select" onchange="changeGlobalFont()">
                        <option value="'Black Ops One', cursive">Black Ops One</option>
                        <option value="'Kanit', sans-serif">Kanit (‡πÑ‡∏ó‡∏¢)</option>
                        <option value="'Orbitron', sans-serif">Orbitron (Sci-Fi)</option>
                        <option value="'Chakra Petch', sans-serif">Chakra Petch</option>
                        <option value="'Press Start 2P', cursive">Pixel (8-Bit)</option>
                    </select>
                </div>
            </div>

            <h1 style="margin:0 0 20px 0;">‡πÇ‡∏´‡∏°‡∏î: <span id="gameTitle" style="color:var(--primary);">Roblox</span></h1>

            <div id="timer-container">
                <div id="preview-display" class="digital-font">60</div>
            </div>

            <div id="control-wrapper">
                <div id="timer-controls">
                    <div style="color:#888; font-size:12px; margin-bottom:5px; text-align:center;">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</div>
                    <input type="number" id="sec" value="60" onchange="updatePreviewStatic()">
                    
                    <div class="btn-group">
                        <button class="btn-reset" onclick="handleReset()"><i class="fas fa-stop"></i> RESET (R)</button>
                        <button class="btn-start" onclick="handleStart()"><i class="fas fa-play"></i> START (Space)</button>
                    </div>
                    
                    <div id="ahk-section" class="ahk-box hide-box" style="margin-top:15px;">
                        <div style="color:var(--accent-orange); font-size:12px; margin-bottom:5px;">Room ID for AHK</div>
                        <div style="display:flex; background:#121212; padding:5px; border-radius:8px;">
                            <input type="text" id="onlyUpRoomId" readonly style="background:transparent; border:none; color:#aaa; font-size:12px;">
                            <button style="background:var(--accent-orange); color:black; padding:5px 10px; width:auto; font-size:10px;" onclick="copyId()">COPY</button>
                        </div>
                    </div>
                </div>

                <div id="text-controls" class="hide-box">
                    <textarea id="textMsg" rows="2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." class="custom-input" style="font-size:18px; margin-bottom:15px;"></textarea>
                    <button class="btn-send" onclick="handleSendText()" style="width:100%;"><i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠</button>
                </div>

                <div style="margin-top:30px; padding-top:15px; border-top:1px solid #333;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">üîó Overlay Link</div>
                    <div style="display:flex; background:#121212; padding:5px; border-radius:8px; border:1px solid #333;">
                        <input type="text" id="overlayLink" readonly style="background:transparent; border:none; flex:1; color:#aaa; font-size:12px; outline:none;">
                        <button style="background:#333; width:auto; font-size:10px; padding:5px 10px;" onclick="copyLink()">COPY</button>
                    </div>
                    <div class="reset-zone-btn" onclick="handleResetLink()"><i class="fas fa-sync-alt"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà / ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå</div>
                </div>
            </div>
        </div>
    </div>

    <div id="hijack-overlay" class="overlay-backdrop hide-box">
        <div class="hijack-modal">
            <div class="hijack-header">
                <span><i class="fas fa-user-secret"></i> REMOTE CONTROL</span>
                <button class="btn-close" onclick="closeHijackModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="hijack-body">
                <div style="background:#000; border-radius:10px; height:80px; display:flex; align-items:center; justify-content:center; margin-bottom:15px;">
                    <div id="hijack-preview" class="digital-font" style="font-size:40px; color:white;">READY</div>
                </div>
                
                <div style="display:flex; justify-content:center; margin-bottom:15px;">
                    <div class="h-mode-btn active" onclick="selectHijackGame('Roblox', this)">Roblox</div>
                    <div class="h-mode-btn" onclick="selectHijackGame('OnlyUp', this)">OnlyUp</div>
                    <div class="h-mode-btn" onclick="selectHijackGame('Talk', this)">Talk</div>
                </div>

                <div id="hijack-timer-inputs">
                    <input type="number" id="hijack-sec" value="60" style="font-size:20px; padding:8px; margin-bottom:15px;">
                </div>
                <div id="hijack-text-inputs" class="hide-box">
                    <textarea id="hijack-msg" class="custom-input" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="margin-bottom:15px;"></textarea>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn-reset" onclick="hijackReset()">STOP</button>
                    <button class="btn-send" onclick="hijackStart()">SEND</button>
                </div>
                <div id="hijack-target-email" style="font-size:10px; color:#555; margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDgn9Vll-qcLhw7dcNtA9oGKy_BCRuefIs", authDomain: "control-tiktok.firebaseapp.com", databaseURL: "https://control-tiktok-default-rtdb.firebaseio.com", projectId: "control-tiktok", storageBucket: "control-tiktok.firebasestorage.app", messagingSenderId: "771700169818", appId: "1:771700169818:web:abe98c40c5b1baabab0c63" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const ADMIN_UID = "kReiv2Nvp6MbQXiiuyGzsG9xb6c2";

        let myRoomId = "", currentRoomId = "", hijackRoomId = "";
        let isAdmin = false, isTextMode = false;
        let previewInterval = null, currentHijackGame = 'Roblox';
        
        // Settings State
        let selectedFont = "'Black Ops One', cursive";
        let isSoundOn = false;
        let soundStartAt = 10;
        let lastPlayedSec = -1;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-overlay').classList.add('hide-box');
                document.getElementById('display-email').innerText = user.email;
                let suffix = localStorage.getItem('room_s_' + user.uid) || Math.floor(1000 + Math.random() * 9000);
                localStorage.setItem('room_s_' + user.uid, suffix);
                myRoomId = `room_${user.uid.substring(0, 8)}_${suffix}`;
                
                // Save room info
                database.ref(myRoomId).update({ email: user.email, lastOnline: Date.now() });

                if (user.uid === ADMIN_UID) {
                    isAdmin = true;
                    document.getElementById('admin-menu').classList.remove('hide-box');
                    loadRooms();
                }
                switchToMyRoom();
            } else {
                document.getElementById('login-overlay').classList.remove('hide-box');
            }
        });

        function handleLogin() {
            auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
                .catch(e => document.getElementById('login-error').innerText = e.message);
        }
        function handleLogout() { auth.signOut().then(() => location.reload()); }

        // --- SETTINGS UI ---
        function toggleSettings() {
            document.getElementById('settings-menu').classList.toggle('hide-box');
        }
        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('sound-toggle');
            if(isSoundOn) { btn.classList.add('on'); playSoundEffect(); }
            else { btn.classList.remove('on'); }
        }
        function changeGlobalFont() {
            selectedFont = document.getElementById('font-select').value;
            if(!isTextMode) document.getElementById('preview-display').style.fontFamily = selectedFont;
        }
        
        // --- SOUND LOGIC ---
        function playBeep(freq, type, dur) {
            if (!isSoundOn) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = type; osc.frequency.value = freq;
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + dur);
            osc.start(now); osc.stop(now + dur);
        }
        function playSoundEffect() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const type = document.getElementById('sound-type').value;
            switch(type) {
                case 'classic': playBeep(440, 'sine', 0.1); break;
                case 'high': playBeep(880, 'triangle', 0.1); break;
                case '8bit': playBeep(220, 'square', 0.1); break;
                case 'low': playBeep(150, 'sawtooth', 0.2); break;
                case 'soft': playBeep(600, 'sine', 0.3); break;
            }
        }
        function previewSound() { if(isSoundOn) playSoundEffect(); }

        // --- GAME LOGIC ---
        function selectGame(name, time, btn) {
            document.querySelectorAll('.game-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            document.getElementById('gameTitle').innerText = name;
            
            document.getElementById('admin-panel-view').classList.add('hide-box');
            document.getElementById('control-panel-view').classList.remove('hide-box');

            if (name === 'OnlyUp') document.getElementById('ahk-section').classList.remove('hide-box');
            else document.getElementById('ahk-section').classList.add('hide-box');

            if (name === 'Talk') {
                isTextMode = true;
                document.getElementById('timer-controls').classList.add('hide-box');
                document.getElementById('text-controls').classList.remove('hide-box');
                resetPreview();
                document.getElementById('preview-display').innerText = "TALK MODE";
                document.getElementById('preview-display').style.fontFamily = "'Kanit', sans-serif";
                document.getElementById('preview-display').style.fontSize = "30px";
                document.getElementById('preview-display').style.color = "#aaa";
            } else {
                isTextMode = false;
                document.getElementById('timer-controls').classList.remove('hide-box');
                document.getElementById('text-controls').classList.add('hide-box');
                document.getElementById('sec').value = time;
                resetPreview();
                updatePreviewStatic();
            }
        }

        function handleStart() {
            const dur = parseInt(document.getElementById('sec').value);
            const game = document.getElementById('gameTitle').innerText;
            const now = Date.now();
            soundStartAt = parseInt(document.getElementById('sound-sec-start').value) || 10;
            
            database.ref(currentRoomId).update({
                mode: 'running', target: now + (dur*1000) + 2500, duration: dur, game: game, font: selectedFont, timestamp: now
            });
            startTimerSim(dur);
        }

        function handleSendText() {
            const msg = document.getElementById('textMsg').value;
            database.ref(currentRoomId).update({ mode: 'text', message: msg, font: "'Kanit', sans-serif", timestamp: Date.now() });
            const preview = document.getElementById('preview-display');
            preview.innerText = msg;
            preview.style.fontFamily = "'Kanit', sans-serif";
            preview.style.fontSize = "30px";
            preview.style.color = "white";
            document.getElementById('textMsg').value = "";
        }

        function handleReset() {
            database.ref(currentRoomId).update({ mode: 'stop' });
            resetPreview();
            if(!isTextMode) updatePreviewStatic();
        }

        function startTimerSim(duration) {
            const el = document.getElementById('preview-display');
            const start = Date.now();
            const end = start + (duration * 1000) + 2500;
            
            el.style.fontFamily = selectedFont; // Apply font
            el.style.fontSize = "70px";
            el.style.color = "white";

            if(previewInterval) clearInterval(previewInterval);
            lastPlayedSec = -1;

            previewInterval = setInterval(() => {
                const left = end - Date.now();
                if (Date.now() - start < 2500) {
                    el.innerText = "READY"; el.className = "preview-intro";
                    el.style.fontFamily = selectedFont;
                } else if (left <= 0) {
                    el.innerText = "0"; el.classList.remove('preview-intro');
                    clearInterval(previewInterval);
                    if(isSoundOn) playSoundEffect();
                } else {
                    const sec = Math.ceil(left/1000);
                    el.innerText = sec; el.classList.remove('preview-intro');
                    if(sec <= 3) el.classList.add('preview-panic'); else el.classList.remove('preview-panic');
                    if (isSoundOn && sec <= soundStartAt && sec !== lastPlayedSec) {
                        playSoundEffect(); lastPlayedSec = sec;
                    }
                }
            }, 50);
        }

        // --- UTILS ---
        function switchToMyRoom() { currentRoomId = myRoomId; updateUI(); selectGame('Roblox', 60, document.querySelectorAll('.game-btn')[0]); }
        function handleResetLink() {
            if(!confirm("Create new room?")) return;
            const s = Math.floor(1000 + Math.random() * 9000);
            localStorage.setItem('room_s_' + auth.currentUser.uid, s);
            myRoomId = `room_${auth.currentUser.uid.substring(0, 8)}_${s}`;
            switchToMyRoom();
        }
        function updateUI() {
            const base = window.location.href.replace('index.html','').replace('control.html',''); 
            const url = base.endsWith('/') ? base : base + '/';
            document.getElementById('overlayLink').value = `${url}overlay.html?id=${currentRoomId}`;
            document.getElementById('onlyUpRoomId').value = currentRoomId;
        }
        function updatePreviewStatic() { 
            const el = document.getElementById('preview-display');
            el.innerText = document.getElementById('sec').value; 
            el.style.fontFamily = selectedFont;
        }
        function copyLink() { navigator.clipboard.writeText(document.getElementById('overlayLink').value); alert("Copied!"); }
        function copyId() { navigator.clipboard.writeText(document.getElementById('onlyUpRoomId').value); alert("Copied!"); }
        function resetPreview() {
            if(previewInterval) clearInterval(previewInterval);
            const el = document.getElementById('preview-display');
            el.className = "digital-font"; 
            el.style.fontFamily = selectedFont;
            el.style.color = "white";
        }

        // --- ADMIN ---
        function loadRooms() {
            database.ref().on('value', s => {
                const list = document.getElementById('room-list'); list.innerHTML = '';
                const rooms = s.val();
                for(let r in rooms) {
                    if(!r.startsWith('room_') || r === myRoomId) continue;
                    list.innerHTML += `<div class="room-card">
                        <div style="font-size:12px; color:white;">${rooms[r].email}</div>
                        <div style="font-size:10px; color:#888;">${r}</div>
                        <button class="btn-mini" style="margin-top:5px; width:100%; background:var(--accent-blue); color:white;" 
                        onclick="openHijackModal('${r}', '${rooms[r].email}')">CONTROL</button>
                    </div>`;
                }
            });
        }
        function showAdminPanel() {
            document.getElementById('admin-panel-view').classList.remove('hide-box');
            document.getElementById('control-panel-view').classList.add('hide-box');
        }
        function openHijackModal(id, email) {
            hijackRoomId = id;
            document.getElementById('hijack-overlay').classList.remove('hide-box');
            document.getElementById('hijack-target-email').innerText = email;
            selectHijackGame('Roblox', document.querySelectorAll('.h-mode-btn')[0]);
        }
        function closeHijackModal() { document.getElementById('hijack-overlay').classList.add('hide-box'); }
        function selectHijackGame(mode, btn) {
            currentHijackGame = mode;
            document.querySelectorAll('.h-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(mode === 'Talk') {
                document.getElementById('hijack-timer-inputs').classList.add('hide-box');
                document.getElementById('hijack-text-inputs').classList.remove('hide-box');
                document.getElementById('hijack-preview').style.fontFamily = "'Kanit', sans-serif";
                document.getElementById('hijack-preview').style.fontSize = "24px";
                document.getElementById('hijack-preview').innerText = "TEXT MODE";
            } else {
                document.getElementById('hijack-timer-inputs').classList.remove('hide-box');
                document.getElementById('hijack-text-inputs').classList.add('hide-box');
                document.getElementById('hijack-preview').style.fontFamily = "'Black Ops One', cursive";
                document.getElementById('hijack-preview').style.fontSize = "40px";
                document.getElementById('hijack-preview').innerText = "READY";
            }
        }
        function hijackStart() {
            const now = Date.now();
            if(currentHijackGame === 'Talk') {
                const msg = document.getElementById('hijack-msg').value;
                database.ref(hijackRoomId).update({ mode: 'text', message: msg, font: "'Kanit', sans-serif", timestamp: now });
                document.getElementById('hijack-preview').innerText = msg;
            } else {
                const dur = parseInt(document.getElementById('hijack-sec').value);
                database.ref(hijackRoomId).update({ mode: 'running', target: now+(dur*1000)+2500, duration: dur, game: currentHijackGame, timestamp: now });
            }
        }
        function hijackReset() { database.ref(hijackRoomId).update({ mode: 'stop' }); }

        document.addEventListener("keydown", (e) => {
            if (isTextMode && e.key === "Enter") { e.preventDefault(); handleSendText(); }
            if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA") return;
            if (!isTextMode) {
                if (e.key === " ") { e.preventDefault(); handleStart(); }
                if (e.key === "r" || e.key === "R") { handleReset(); }
            }
        });
    </script>
</body>
</html>
