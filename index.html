<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Control Deck (Pro Version)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Chakra+Petch:wght@600&family=Kanit:wght@300;600&family=Orbitron:wght@700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --bg-sidebar: #181818;
            --primary: #00e676;
            --danger: #ff5252;
            --text-main: #ffffff;
            --text-muted: #b0bec5;
            --accent-blue: #2979ff;
            --accent-orange: #ff9100;
            --admin-purple: #d500f9;
        }

        * { box-sizing: border-box; }
        
        /* Global Font Defaults */
        body, input, button, select, textarea { 
            font-family: 'Kanit', sans-serif; 
        }

        /* Digital Font Style (For Timer) */
        .digital-font {
            font-family: 'Black Ops One', cursive; /* Default */
            font-size: 70px;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        body { 
            margin: 0; padding: 0; 
            background: var(--bg-dark); 
            color: var(--text-main);
            height: 100vh; 
            display: flex; 
            overflow: hidden;
        }

        /* --- UI COMPONENTS --- */
        .hide-box { display: none !important; }
        .hidden { opacity: 0 !important; }

        /* Login */
        #login-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .login-box {
            background: var(--bg-card); padding: 40px; border-radius: 20px;
            width: 100%; max-width: 350px; text-align: center; 
            border: 1px solid #333; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* User Info */
        .user-info-top {
            position: fixed; top: 15px; right: 20px; font-size: 12px;
            background: rgba(30,30,30,0.9); padding: 8px 15px; border-radius: 20px;
            display: flex; align-items: center; gap: 10px; z-index: 1500; 
            border: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Sidebar */
        .sidebar { 
            width: 260px; background: var(--bg-sidebar); border-right: 1px solid #333; 
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3); z-index: 10;
        }
        .brand { font-size: 20px; font-weight: 600; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .menu-label { font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        
        .game-btn {
            padding: 12px 15px; border-radius: 8px; background: transparent; color: var(--text-muted);
            cursor: pointer; font-size: 16px; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 12px; border: 1px solid transparent;
        }
        .game-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .game-btn.active { background: rgba(0, 230, 118, 0.15); color: var(--primary); border: 1px solid rgba(0, 230, 118, 0.3); font-weight: 600; }
        
        .admin-section { margin-top: auto; border-top: 1px solid #333; padding-top: 20px; }
        .admin-btn { border: 1px dashed var(--accent-blue) !important; color: var(--accent-blue) !important; }
        .admin-btn.active { background: rgba(41, 121, 255, 0.15); color: white !important; }
        .my-room-btn { border: 1px solid var(--primary) !important; color: var(--primary) !important; margin-bottom: 10px; }
        .my-room-btn:hover { background: rgba(0, 230, 118, 0.1) !important; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 30px; overflow-y: auto; align-items: center; }
        .dashboard-card { background: var(--bg-card); border-radius: 20px; padding: 40px; width: 100%; max-width: 600px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* Admin Grid */
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; width: 100%; }
        .room-card { 
            background: #151515; border: 1px solid #333; border-radius: 12px; padding: 15px; 
            text-align: left; transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .room-card:hover { border-color: var(--accent-blue); transform: translateY(-3px); }
        .btn-mini { padding: 6px 12px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer; margin-right: 5px; font-weight: 600; letter-spacing: 0.5px; }

        /* Controls */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        #timer-container { background: #000; border: 4px solid #333; border-radius: 12px; height: 180px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); }
        
        #preview-display { 
            color: white; text-align: center; 
        }

        .control-group { margin-bottom: 20px; text-align: center; }
        .custom-input { background: #2a2a2a; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; outline: none; font-size: 14px; transition: 0.3s; width:100%; }
        .custom-input:focus { border-color: var(--primary); }
        
        input[type="number"] { background: #2a2a2a; border: 2px solid #444; color: white; font-size: 36px; width: 100%; max-width: 200px; text-align: center; padding: 10px; border-radius: 12px; outline: none; }

        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        button { flex: 1; padding: 18px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; color: white; text-transform: uppercase; }
        .btn-start { background: linear-gradient(135deg, #00e676, #00b359); box-shadow: 0 4px 15px rgba(0,230,118,0.3); }
        .btn-reset { background: #333; color: #ff5252; border: 1px solid #ff5252; }
        .btn-send { background: linear-gradient(135deg, #2979ff, #1565c0); }

        /* AHK Box */
        .ahk-box { background: rgba(255, 145, 0, 0.1); border: 1px solid var(--accent-orange); border-radius: 12px; padding: 15px; margin-top: 15px; text-align: left; }

        /* --- SETTINGS BOX (NEW) --- */
        .settings-box {
            display: flex; flex-direction: column; gap: 15px;
            background: #252525; border: 1px solid #444; border-radius: 12px;
            padding: 15px; margin-bottom: 20px;
        }
        .setting-row { display: flex; justify-content: space-between; align-items: center; }
        
        /* Sound Toggle Switch */
        .sound-toggle-btn {
            background: #444; width: 50px; height: 26px; border-radius: 13px;
            position: relative; cursor: pointer; transition: 0.3s;
        }
        .sound-toggle-btn.on { background: var(--primary); }
        .sound-toggle-circle {
            width: 20px; height: 20px; background: white; border-radius: 50%;
            position: absolute; top: 3px; left: 3px; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .sound-toggle-btn.on .sound-toggle-circle { left: 27px; }
        
        /* Small Inputs */
        .sm-input { width: 60px; font-size: 14px; padding: 5px; height: 35px; border: 1px solid #555; background: #1a1a1a; text-align: center; color: white; border-radius: 5px;}
        .sm-select { background: #1a1a1a; border: 1px solid #555; color: #ccc; padding: 5px; height: 35px; border-radius: 5px; cursor: pointer; font-size: 13px;}

        /* Animation */
        .preview-intro { color: #ffd700 !important; font-size: 36px !important; }
        .preview-panic { color: #ff0000 !important; animation: panic-pulse 0.5s infinite; }
        @keyframes panic-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .status-badge-my { background: rgba(0, 230, 118, 0.2); color: var(--primary); padding: 5px 10px; border-radius: 10px; font-size: 12px; border: 1px solid var(--primary); }
        .status-badge-hijack { background: rgba(213, 0, 249, 0.2); color: var(--admin-purple); padding: 5px 10px; border-radius: 10px; font-size: 12px; border: 1px solid var(--admin-purple); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-top:0;"><i class="fas fa-shield-alt"></i> SYSTEM LOGIN</h2>
            <input type="email" id="email" class="custom-input" placeholder="Email" style="text-align: center; margin-bottom: 10px;">
            <input type="password" id="password" class="custom-input" placeholder="Password" style="text-align: center; margin-bottom: 20px;" onkeyup="if(event.key === 'Enter') handleLogin()">
            <button onclick="handleLogin()" style="background: var(--primary); color: #000; width: 100%; font-weight: bold; border-radius: 8px;">LOGIN</button>
            <p id="login-error" style="color: var(--danger); font-size: 13px; margin-top: 15px;"></p>
        </div>
    </div>

    <div id="user-display" class="user-info-top hide-box">
        <span id="role-badge" style="font-size: 10px; background: var(--accent-blue); padding: 2px 8px; border-radius: 10px; font-weight: bold;">USER</span>
        <span id="display-email" style="color: #ddd;"></span>
        <i class="fas fa-sign-out-alt" style="color: var(--danger); cursor: pointer; margin-left: 10px;" onclick="handleLogout()" title="Logout"></i>
    </div>

    <div class="sidebar">
        <div class="brand"><i class="fas fa-gamepad"></i> STiMEXs <span style="font-size:10px; opacity:0.5;">v4.0</span></div>
        <div>
            <div class="menu-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°</div>
            <div class="game-btn active" onclick="selectGame('Roblox', 60, this)"><i class="fas fa-cube"></i> Roblox</div>
            <div class="game-btn" onclick="selectGame('OnlyUp', 10, this)"><i class="fas fa-arrow-up"></i> OnlyUp</div>
            <div class="game-btn" onclick="selectGame('Horror', 60, this)"><i class="fas fa-ghost"></i> Horror</div>
            <div class="game-btn" onclick="selectGame('Talk', 0, this)"><i class="fas fa-comment-dots"></i> Talk / Chat</div>
        </div>
        
        <div id="admin-menu" class="admin-section hide-box">
            <div class="menu-label">ADMIN SYSTEM</div>
            <div id="btn-my-room" class="game-btn my-room-btn" onclick="switchToMyRoom()">
                <i class="fas fa-user-astronaut"></i> My Control
            </div>
            <div id="btn-admin-view" class="game-btn admin-btn" onclick="showAdminPanel()">
                <i class="fas fa-users-cog"></i> Active Rooms
            </div>
        </div>
    </div>

    <div class="main-content">
        
        <div id="admin-panel-view" class="dashboard-card hide-box" style="max-width: 900px; width: 100%;">
            <div class="header-row">
                <h2 style="color: var(--accent-blue); margin: 0;"><i class="fas fa-satellite-dish"></i> Active Rooms Monitor</h2>
                <button class="btn-mini" style="width: auto; background: #333;" onclick="loadRooms()">REFRESH</button>
            </div>
            <div class="room-grid" id="room-list"></div>
        </div>

        <div id="control-panel-view" class="dashboard-card">
            <div class="header-row">
                <div class="header-title"><h1>‡πÇ‡∏´‡∏°‡∏î: <span id="gameTitle">Roblox</span></h1></div>
                <div id="target-info"></div>
            </div>

            <div class="control-label" style="text-align: left; margin-bottom: 5px;">LIVE PREVIEW</div>
            <div id="timer-container">
                <div id="preview-display" class="digital-font">60</div>
            </div>

            <div id="control-wrapper">
                <div id="timer-controls" class="control-group">
                    
                    <div class="settings-box">
                        <div class="setting-row" style="margin-bottom: 10px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div id="sound-toggle" class="sound-toggle-btn" onclick="toggleSound()">
                                    <div class="sound-toggle-circle"></div>
                                </div>
                                <div style="font-size:14px; font-weight:600; color:#ddd;">
                                    <i class="fas fa-volume-up"></i> Sound
                                </div>
                            </div>
                            
                            <div style="display:flex; align-items:center; gap:8px;">
                                <select id="sound-type" class="sm-select" onchange="previewSound()">
                                    <option value="classic">Classic</option>
                                    <option value="high">High Pitch</option>
                                    <option value="8bit">8-Bit</option>
                                    <option value="low">Low Alert</option>
                                    <option value="soft">Soft Bell</option>
                                </select>
                                <span style="font-size:12px; color:#aaa;">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</span>
                                <input type="number" id="sound-sec-start" value="10" class="sm-input">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div style="font-size:14px; font-weight:600; color:#ddd;">
                                <i class="fas fa-font"></i> Font
                            </div>
                            <select id="font-select" class="sm-select" style="flex:1; margin-left:10px;" onchange="changeGlobalFont()">
                                <option value="'Black Ops One', cursive">Black Ops One (Default)</option>
                                <option value="'Kanit', sans-serif">Kanit (‡πÑ‡∏ó‡∏¢)</option>
                                <option value="'Orbitron', sans-serif">Orbitron (Sci-Fi)</option>
                                <option value="'Chakra Petch', sans-serif">Chakra Petch (Tech)</option>
                                <option value="'Press Start 2P', cursive">Pixel (8-Bit)</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-label">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</div>
                    <input type="number" id="sec" value="60" onchange="updatePreviewStatic()">
                    
                    <div class="btn-group">
                        <button class="btn-reset" onclick="handleReset()"><i class="fas fa-stop"></i> Reset (R)</button>
                        <button class="btn-start" onclick="handleStart()"><i class="fas fa-play"></i> START (Space)</button>
                    </div>

                    <div id="ahk-section" class="ahk-box hide-box">
                        <div style="color: var(--accent-orange); font-size: 14px; font-weight: 600; margin-bottom: 8px;">
                            <i class="fas fa-robot"></i> Room ID for AutoHotkey
                        </div>
                        <div style="display: flex; background: #121212; padding: 5px; border-radius: 8px; border: 1px solid #333; align-items: center;">
                            <input type="text" id="onlyUpRoomId" style="flex: 1; background: transparent; border: none; color: #aaa; padding: 8px; font-size: 12px; outline: none;" readonly>
                            <button class="btn-mini" style="background: var(--accent-orange); color: black;" onclick="copyId()">COPY</button>
                        </div>
                    </div>
                </div>

                <div id="text-controls" class="control-group hide-box">
                    <textarea id="textMsg" rows="2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." class="custom-input"></textarea>
                    <button class="btn-send" onclick="handleSendText()" style="width:100%; margin-top:15px;">
                        <i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠
                    </button>
                </div>

                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;">
                    <div class="control-label" style="font-size: 12px; text-align: left;">üîó Overlay Link (OBS)</div>
                    <div style="display: flex; background: #121212; padding: 5px; border-radius: 8px; border: 1px solid #333; align-items: center;">
                        <input type="text" id="overlayLink" style="flex: 1; background: transparent; border: none; color: #aaa; padding: 8px; font-size: 12px; outline: none;" readonly>
                        <button class="btn-mini" style="background: #333; color: white;" onclick="copyLink()">COPY</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const ADMIN_UID = "kReiv2Nvp6MbQXiiuyGzsG9xb6c2"; 
        const firebaseConfig = {
            apiKey: "AIzaSyDgn9Vll-qcLhw7dcNtA9oGKy_BCRuefIs",
            authDomain: "control-tiktok.firebaseapp.com",
            databaseURL: "https://control-tiktok-default-rtdb.firebaseio.com",
            projectId: "control-tiktok",
            storageBucket: "control-tiktok.firebasestorage.app",
            messagingSenderId: "771700169818",
            appId: "1:771700169818:web:abe98c40c5b1baabab0c63"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Variables
        let myPersonalRoomId = "";
        let currentRoomId = "";
        let isAdmin = false;
        let previewInterval = null;
        let previewTimeout = null;
        let isTextMode = false;
        
        // --- NEW VARIABLES FOR SETTINGS ---
        let selectedFont = "'Black Ops One', cursive";
        let isSoundOn = false;
        let soundStartAt = 10;
        let lastPlayedSec = -1; // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏¥‡πÄ‡∏î‡∏¥‡∏°
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- SOUND SYSTEM ---
        function playBeep(freq, type, dur, vol) {
            if (!isSoundOn) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); 
            gain.connect(audioCtx.destination);
            
            osc.type = type; 
            osc.frequency.value = freq;
            
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(vol, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + dur);
            
            osc.start(now);
            osc.stop(now + dur);
        }

        function playSoundEffect() {
            // Resume Context if suspended (browser policy)
            if(audioCtx.state === 'suspended') audioCtx.resume();

            const soundType = document.getElementById('sound-type').value;

            switch(soundType) {
                case 'classic': playBeep(440, 'sine', 0.1, 0.5); break; 
                case 'high': playBeep(880, 'triangle', 0.1, 0.4); break; 
                case '8bit': playBeep(220, 'square', 0.1, 0.3); break; 
                case 'low': playBeep(150, 'sawtooth', 0.2, 0.3); break; 
                case 'soft': playBeep(600, 'sine', 0.3, 0.3); break; 
            }
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('sound-toggle');
            if (isSoundOn) {
                btn.classList.add('on');
                playSoundEffect(); // Play once to confirm
            } else {
                btn.classList.remove('on');
            }
        }

        function previewSound() {
            if(isSoundOn) playSoundEffect();
        }

        // --- FONT SYSTEM ---
        function changeGlobalFont() {
            selectedFont = document.getElementById('font-select').value;
            // Apply to local preview immediately
            if(!isTextMode) {
                document.getElementById('preview-display').style.fontFamily = selectedFont;
            }
        }

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-overlay').classList.add('hide-box');
                document.getElementById('user-display').classList.remove('hide-box');
                document.getElementById('display-email').innerText = user.email;
                myPersonalRoomId = `room_${user.uid.substring(0, 8)}`;
                if (user.uid === ADMIN_UID) {
                    isAdmin = true;
                    document.getElementById('admin-menu').classList.remove('hide-box');
                    document.getElementById('role-badge').innerText = "ADMIN MASTER";
                    document.getElementById('role-badge').style.background = "#d500f9"; 
                    loadRooms(); showAdminPanel(); 
                } else {
                    isAdmin = false;
                    document.getElementById('admin-menu').classList.add('hide-box');
                    switchToMyRoom();
                }
            } else {
                document.getElementById('login-overlay').classList.remove('hide-box');
                document.getElementById('user-display').classList.add('hide-box');
                document.getElementById('admin-menu').classList.add('hide-box');
            }
        });

        function handleLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => document.getElementById('login-error').innerText = err.message);
        }
        function handleLogout() { auth.signOut().then(() => location.reload()); }

        // --- LOGIC ---
        function switchToMyRoom() {
            currentRoomId = myPersonalRoomId;
            document.getElementById('admin-panel-view').classList.add('hide-box');
            document.getElementById('control-panel-view').classList.remove('hide-box');
            if(isAdmin) document.getElementById('btn-admin-view').classList.remove('active');
            document.querySelectorAll('.game-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.game-btn')[0].classList.add('active');
            updateRoomUI();
            selectGame('Roblox', 60, document.querySelectorAll('.game-btn')[0]);
        }

        function showAdminPanel() {
            document.getElementById('admin-panel-view').classList.remove('hide-box');
            document.getElementById('control-panel-view').classList.add('hide-box');
            document.getElementById('btn-admin-view').classList.add('active');
            document.querySelectorAll('.game-btn').forEach(b => {
                if(!b.classList.contains('admin-btn') && !b.classList.contains('my-room-btn')) b.classList.remove('active');
            });
        }

        function takeControl(id) {
            currentRoomId = id; 
            document.getElementById('admin-panel-view').classList.add('hide-box');
            document.getElementById('control-panel-view').classList.remove('hide-box');
            document.getElementById('btn-admin-view').classList.remove('active');
            updateRoomUI();
            selectGame('Roblox', 60, document.querySelectorAll('.game-btn')[0]);
        }

        function loadRooms() {
            if(!isAdmin) return;
            database.ref().on('value', snapshot => {
                const rooms = snapshot.val();
                const list = document.getElementById('room-list');
                list.innerHTML = '';
                if (!rooms) return;
                for (let id in rooms) {
                    if (id.startsWith('room_')) {
                        const rData = rooms[id];
                        const card = document.createElement('div');
                        card.className = 'room-card';
                        const isMyRoom = (id === myPersonalRoomId);
                        if(isMyRoom) card.style.border = "1px solid var(--primary)";
                        const statusColor = (rData.mode === 'running') ? '#00e676' : '#555';
                        card.innerHTML = `
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <div style="font-size:10px; color:${isMyRoom ? 'var(--primary)' : '#888'};">${isMyRoom ? '‚òÖ YOUR ROOM' : 'ID'}</div>
                                <div style="width:8px; height:8px; border-radius:50%; background:${statusColor};"></div>
                            </div>
                            <div style="font-size:14px; color:white; font-weight:bold; overflow:hidden; text-overflow:ellipsis; margin-bottom:5px;">${id}</div>
                            <div style="font-size:11px; color:#aaa; margin-bottom:10px;">Mode: ${rData.game || '-'} | Status: ${rData.mode || 'Stop'}</div>
                            <button class="btn-mini" style="width:100%; background:var(--accent-blue); color:white;" onclick="takeControl('${id}')"><i class="fas fa-gamepad"></i> CONTROL</button>
                        `;
                        list.appendChild(card);
                    }
                }
            });
        }

        function updateRoomUI() {
            const url = window.location.href.split('?')[0].replace('index.html', '').replace('control.html', ''); 
            const baseUrl = url.endsWith('/') ? url : url + '/';
            const fullLink = `${baseUrl}overlay.html?id=${currentRoomId}`;
            document.getElementById('overlayLink').value = fullLink;
            document.getElementById('onlyUpRoomId').value = currentRoomId; 
            const tInfo = document.getElementById('target-info');
            if (currentRoomId === myPersonalRoomId) tInfo.innerHTML = `<span class="status-badge-my"><i class="fas fa-user"></i> MY ROOM</span>`;
            else tInfo.innerHTML = `<span class="status-badge-hijack"><i class="fas fa-mask"></i> HIJACKING</span>`;
        }

        function selectGame(name, time, btnElement) {
            document.getElementById('gameTitle').innerText = name;
            document.getElementById('admin-panel-view').classList.add('hide-box');
            document.getElementById('control-panel-view').classList.remove('hide-box');
            if(isAdmin) document.getElementById('btn-admin-view').classList.remove('active');
            document.querySelectorAll('.game-btn').forEach(b => {
                if(!b.classList.contains('admin-btn') && !b.classList.contains('my-room-btn')) b.classList.remove('active');
            });
            if(btnElement) btnElement.classList.add('active');
            
            if(name === 'OnlyUp') document.getElementById('ahk-section').classList.remove('hide-box'); 
            else document.getElementById('ahk-section').classList.add('hide-box');

            if (name === 'Talk') {
                isTextMode = true;
                document.getElementById('timer-controls').classList.add('hide-box');
                document.getElementById('text-controls').classList.remove('hide-box');
                resetPreview();
                document.getElementById('preview-display').innerText = "TALK MODE";
                document.getElementById('preview-display').style.fontFamily = "'Kanit', sans-serif";
                document.getElementById('preview-display').style.fontSize = "30px";
                document.getElementById('preview-display').style.color = "#aaa";
            } else {
                isTextMode = false;
                document.getElementById('timer-controls').classList.remove('hide-box');
                document.getElementById('text-controls').classList.add('hide-box');
                document.getElementById('sec').value = time;
                resetPreview();
                updatePreviewStatic();
            }
        }

        function handleStart() {
            if (!currentRoomId || isTextMode) return;
            const dur = parseInt(document.getElementById('sec').value);
            
            // Audio check
            if(audioCtx.state === 'suspended') audioCtx.resume();
            soundStartAt = parseInt(document.getElementById('sound-sec-start').value) || 10;
            
            const now = Date.now();
            const target = now + (dur * 1000) + 2500;
            const game = document.getElementById('gameTitle').innerText;
            
            startPreviewSimulation(dur, game);
            
            // SEND FONT DATA TO FIREBASE
            database.ref(currentRoomId).set({ 
                mode: 'running', 
                target: target, 
                duration: dur, 
                game: game, 
                font: selectedFont, // Sending Font
                timestamp: now 
            });
        }

        function handleReset() {
            if (!currentRoomId) return;
            resetPreview();
            if(!isTextMode) updatePreviewStatic();
            database.ref(currentRoomId).set({ mode: 'stop', target: 0 });
        }

        function handleSendText() {
            const msg = document.getElementById('textMsg').value;
            if(!msg) return;
            
            showTextPreview(msg);
            database.ref(currentRoomId).set({ mode: 'text', message: msg, font: "'Kanit', sans-serif", timestamp: Date.now() });
            document.getElementById('textMsg').value = "";
        }
        
        function copyLink() { navigator.clipboard.writeText(document.getElementById('overlayLink').value); alert("Copied!"); }
        function copyId() { navigator.clipboard.writeText(document.getElementById('onlyUpRoomId').value); alert("Copied!"); }

        function updatePreviewStatic() {
            if(!isTextMode) {
                const el = document.getElementById('preview-display');
                el.innerText = document.getElementById('sec').value;
                el.className = "digital-font"; 
                el.style.fontFamily = selectedFont; // Use Selected Font
                el.style.color = "white";
            }
        }

        function startPreviewSimulation(duration, gameName) {
            const el = document.getElementById('preview-display');
            const start = Date.now();
            const end = start + (duration * 1000) + 2500; 

            if(previewInterval) clearInterval(previewInterval);
            if(previewTimeout) clearTimeout(previewTimeout);
            
            el.style.fontFamily = selectedFont; // Ensure font is applied
            el.style.fontSize = "70px";
            el.style.color = "white";

            lastPlayedSec = -1; // Reset sound tracker

            previewInterval = setInterval(() => {
                const now = Date.now();
                const left = end - now;

                if (now - start < 2500) {
                    el.className = "preview-intro";
                    el.style.fontFamily = selectedFont;
                    if (gameName.includes('Roblox')) el.innerText = "READY";
                    else if (gameName.includes('OnlyUp')) el.innerText = "GO";
                    else el.innerText = "READY";
                } else {
                    if (left <= 0) {
                        el.innerText = "0";
                        el.classList.remove('preview-intro');
                        clearInterval(previewInterval);
                        if(isSoundOn) playSoundEffect(); // Final Beep
                        previewTimeout = setTimeout(() => { el.innerText = duration; }, 2000);
                    } else {
                        const sec = Math.ceil(left / 1000);
                        el.innerText = sec;
                        el.classList.remove('preview-intro');
                        
                        if (sec <= 3) el.classList.add('preview-panic'); 
                        else el.classList.remove('preview-panic');

                        // SOUND LOGIC
                        if (isSoundOn) {
                            if (sec <= soundStartAt && sec !== lastPlayedSec) {
                                playSoundEffect();
                                lastPlayedSec = sec;
                            }
                        }
                    }
                }
            }, 50);
        }

        function showTextPreview(msg) {
            const el = document.getElementById('preview-display');
            if(previewInterval) clearInterval(previewInterval);
            el.innerText = msg;
            el.style.fontFamily = "'Kanit', sans-serif";
            el.style.fontSize = "32px";
            el.style.color = "#2979ff";
            setTimeout(() => { if(isTextMode) el.innerText = "TALK MODE"; }, 5000);
        }

        function resetPreview() {
            if(previewInterval) clearInterval(previewInterval);
            if(previewTimeout) clearTimeout(previewTimeout);
            const el = document.getElementById('preview-display');
            el.className = "digital-font"; 
            el.style.fontFamily = selectedFont;
            el.style.color = "white";
        }

        document.addEventListener("keydown", (e) => {
            if (isTextMode && e.key === "Enter") { e.preventDefault(); handleSendText(); }
            if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA") return;
            if (!isTextMode) {
                if (e.key === " ") { e.preventDefault(); handleStart(); }
                if (e.key === "r" || e.key === "R") { handleReset(); }
            }
        });
    </script>
</body>
</html>
